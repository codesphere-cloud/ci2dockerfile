# ci2dockerfile

The ci2dockerfile CLI tool can be used to convert Codesphere's `ci.yml` format into one or multiple Dockerfiles,
to help deploy Codesphere workspaces to containerized environments, like docker compose, Kubernetes, or OpenShift.

The output generated by `ci2dockerfile` is a folder (default: `./export`) containing the following artifacts:

* `./export/<service-n>` Each service is exported to a separate folder.
* `./export/<service-n>/Dockerfile`  Dockerfile to build the container of the service.
* `./export/<service-n>/entrypoint.sh` Entrypoint of the container (run stage of Codesphere workspace).
* `./export/docker-compose.yml` Environment to allow running the services with docker-compose.
* `./export/nginx.conf` Configuration for NGINX, which is used by the docker compose environment as router between services.

`ci2dockerfile` itself can be downloaded and executed in a Codesphere workspace, so users can generate the artifacts and add them to their project's git repository without leaving Codesphere.

## Usage

### Download Latest Release

Download latest release from the [Release page](https://github.com/codesphere-cloud/ci2dockerfile/releases), e.g.:

```bash
$ wget https://github.com/codesphere-cloud/ci2dockerfile/releases/download/v0.1.4/ci2dockerfile_0.1.4_linux_amd64 -O ci2dockerfile
$ chmod +x ci2dockerfile
```

### Run ci2dockerfile

To export the example run `make example-export-single` and `make example-export-multi` for an old and new ci.yml. To run the newly created example docker compose file run `make run` (only uses the multi/new export).

To use your own command you can use `./ci2dockerfile -b <base_image> -i <ci_yml_path> -o <output_dir> -e <environment_variables>`.

Available parameters are:
- `-b`: Base image for the dockerfile. **(Required)**
- `-i`: Input path for the **ci.yml** file. Default is `./ci.yml`.
- `-o`: Output path of the folder including docker compose and services. Default is `./export`.
- `-e`: Env vars to put into docker compose services. Multiple can be added via multiple `-e` arguments.

### Build and Run Generated Container Images

Using docker-compose, the generated artifacts can be built and started on a local machine:

```bash
$ cd export
$ docker-compose up
```

Each dockerfile can also built separately, e.g. to push it to a registry.

```
$ cd export/<service-n>
$ docker build . -t my-service:latest
$ docker login my-registry.com
$ docker push my-registry.com/my-service:latest
```

Note: Container builds are currently not possible from within Codesphere workspaces.
To automate the builds, you can leverage other tools that hook into your repository, e.g. GitHub actions or Jenkins.

## Build ci2dockerfile

Run `make build` in a terminal of this folder to create the go build.